



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.0">
    
    
      
        <title>Code - Correlated Counts</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.1b62728e.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../css/custom.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#running-a-model" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Correlated Counts" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Correlated Counts
            </span>
            <span class="md-header-nav__topic">
              
                Code
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Correlated Counts" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Correlated Counts
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../methods/" title="Methods" class="md-nav__link">
      Methods
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../models/" title="Models" class="md-nav__link">
      Models
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Code
      </label>
    
    <a href="./" title="Code" class="md-nav__link md-nav__link--active">
      Code
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#specifying-the-model" class="md-nav__link">
    Specifying the Model
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spline-specification" class="md-nav__link">
    Spline Specification
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-specification" class="md-nav__link">
    Example Specification
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fitting-the-model" class="md-nav__link">
    Fitting the Model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-predictions" class="md-nav__link">
    Creating Predictions
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../updates/" title="Release Notes" class="md-nav__link">
      Release Notes
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#specifying-the-model" class="md-nav__link">
    Specifying the Model
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spline-specification" class="md-nav__link">
    Spline Specification
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-specification" class="md-nav__link">
    Example Specification
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fitting-the-model" class="md-nav__link">
    Fitting the Model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-predictions" class="md-nav__link">
    Creating Predictions
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="running-a-model"><a href="#running">Running a Model</a></h1>
<p>The core model is an object called <code>ccount.core.CorrelatedModel</code>. Each of the types of models you can fit are explained in the <a href="../models/">models</a> documetation.</p>
<h2 id="specifying-the-model"><a href="#specification">Specifying the Model</a></h2>
<p>To specify a model, make sure that all variables that you need are contained within one data frame, including covariates, random effects, offsets, and weights. The outcome variables should be wide, but all other variables should be long, e.g. have one column for deaths and another column for cases, rather than one column with deaths and cases stacked on top of each other. All of these variables need to be filled in for every entry (i.e. there can be no missing values -- if you want to predict for somewhere with missing outcome information, you can do that later with the <a href="./#predictions">function</a> that makes predictions).</p>
<p>The function that you can use to initialize a model is <code>ccount.run.convert_df_to_model</code>. This function returns a <code>CorrelatedModel</code> object. It takes the following arguments:</p>
<ul>
<li><code>model_type</code>: <code>(str)</code> The name of the model type to be fit. The list of names are in <a href="../models/">models</a>.</li>
<li><code>df</code>: <code>(pd.DataFrame)</code> A data frame that contains all of your variables.</li>
<li><code>outcome_variables</code>: <code>(List[str])</code> A list of the names of the outcome variables.</li>
<li><code>fixed_effects</code>: <code>(List[List[List[str] or None]])</code> Nested lists of the names of fixed effects to put on each of the parameters and outcomes. See <a href="../models/#parametrization">here</a> for details. If you do <strong>not</strong> want to put any covariates on a parameter-outcome combination, pass <code>None</code> instead of <code>List[str]</code>. <em>Note: Intercepts are automatically added for each parameter-outcome. Do not add another intercept.</em></li>
<li><code>random_effect</code>: <code>(str)</code> Name of the variable that specifies the grouping of the random effect.</li>
<li><code>spline</code>: <code>(List[List[List[dict] or None]])</code> Nested lists of dictionaries that gives the spline specification</li>
<li><code>offset</code>: <code>List[str]</code> (optional) List of variable names to use as an offset for each parameter. Must be of the length of the number of parameters in each model, <strong>and in the correct order</strong>. See <a href="../models/#choices">here</a> for the number and order of parameters for each model type. To include an offset on only one parameter, pass a list of the variable name and <code>None</code>, in the correct order corresponding to your model type.</li>
<li><code>weight</code>: <code>(str)</code> (optional) Name of the variable that specifies the weight to place on each observation.</li>
<li><code>**kwargs</code>: Additional arguments<ul>
<li><code>normalize_X</code>: <code>(bool)</code> Whether or not to scale the covariates by their mean and standard deviation. By default, <code>normalize_X = True</code>. The resulting parameters are transformed after fitting so that they can be interpreted in the original space as the covariates.</li>
<li><code>add_intercepts</code>: <code>(bool)</code> Whether or not to add intercepts for all parameter-outcomes. By default, <code>add_intercepts = True</code>.</li>
</ul>
</li>
</ul>
<h4 id="spline-specification">Spline Specification</h4>
<p>Fitting a spline requires additional information. For each spline that you want to add, you pass a dictionary rather than a string (like you do for fixed effects).
The dictionary must have the following keys:</p>
<ul>
<li><code>name</code>: <code>(str)</code> variable name in your dataset for the spline</li>
<li><code>knots_type</code>: <code>(str)</code> one of <code>"frequency"</code> (put the knots at equal quantiles of the data) or <code>"domain"</code> (put the knots at equal spacings over the domain of the variable)</li>
<li><code>knots_num</code>: <code>(int)</code> number of knots for the spline</li>
<li><code>degree</code>: <code>(int)</code> degree of differentiation for the spline (e.g. degree of 3 is a cubic spline, most common for this application)</li>
<li><code>r_linear</code>: <code>(bool)</code> enforce linear function (rather than a potentially degree &gt; 1 spline) at the tails of your data on the <em>right</em></li>
<li><code>l_linear</code>: <code>(bool)</code> enforce linear function (rather than a potentially degree &gt; 1 spline) at the tails of your data on the <em>left</em></li>
</ul>
<h3 id="example-specification">Example Specification</h3>
<p>Consider a pandas data frame, <code>df</code>, that has the following columns: <code>deaths</code>, <code>cases</code>, <code>median_income</code>, <code>population</code>, <code>country</code>, <code>age</code>. In my example below, I will fit a Zero-Inflated Poisson model (described <a href="../models/#zip">here</a>) with the following:</p>
<p><em>Outcomes</em></p>
<ul>
<li>predict both deaths due to and cases of a disease, where deaths and cases are correlated with one another (2-dimensional outcome)</li>
</ul>
<p><em>Fixed Effects</em></p>
<ul>
<li>median income as a predictor for the mean of deaths</li>
<li>age as a predictor for the mean of cases</li>
<li>no predictors for the probability of a structural zero</li>
</ul>
<p><em>Splines</em>
- a spline over calendar year with 3 degrees of freedom (cubic), and 3 knots (two at the min and max of the variable, one at the median), no linearity in tails
- only applied to the mean, but applied to both cases and deaths</p>
<p>Let's specify the spline here, and in the example we will apply the spline specification to the mean function for both outcomes.</p>
<div class="codehilite"><pre><span></span><span class="n">spline_specs</span> <span class="o">=</span> <span class="err">{</span>
    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span>
    <span class="s1">&#39;knots_type&#39;</span><span class="p">:</span> <span class="s1">&#39;frequency&#39;</span><span class="p">,</span>
    <span class="s1">&#39;knots_num&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;degree&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;r_linear&#39;</span><span class="p">:</span> <span class="k">False</span><span class="p">,</span>
    <span class="s1">&#39;l_linear&#39;</span><span class="p">:</span> <span class="k">False</span>
<span class="err">}</span>
</pre></div>


<p><em>Random Effect</em></p>
<ul>
<li>random effect grouping by country, so that all data points within the same country will have the same 2-dimensional realization that correlates their deaths with their cases</li>
</ul>
<p><em>Offset</em></p>
<ul>
<li>population as the "offset" for the mean, or the denominator that deaths and cases came from</li>
</ul>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">ccount.run</span> <span class="kn">import</span> <span class="n">convert_df_to_model</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">convert_df_to_model</span><span class="p">(</span>
    <span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;zero_inflated_poisson&#39;</span><span class="p">,</span>
    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
    <span class="n">outcome_variables</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;deaths&#39;</span><span class="p">,</span> <span class="s1">&#39;cases&#39;</span><span class="p">],</span>
    <span class="n">fixed_effects</span><span class="o">=</span><span class="p">[[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span> <span class="p">[[</span><span class="s1">&#39;median_income&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]]],</span>
    <span class="n">random_effect</span><span class="o">=</span><span class="s1">&#39;country&#39;</span><span class="p">,</span>
    <span class="n">offset</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;population&#39;</span><span class="p">],</span>
    <span class="n">spline</span><span class="o">=</span><span class="p">[[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>
        <span class="p">[[</span><span class="n">spline_specs</span><span class="p">],</span> <span class="p">[</span><span class="n">spline_specs</span><span class="p">]]</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>


<h2 id="fitting-the-model"><a href="#optimization">Fitting the Model</a></h2>
<p>Once you have the model object, returned by the function <code>model = convert_df_to_model(...)</code>, we can estimate the parameters. The class method <code>ccount.core.CorrelatedModel.optimize_params</code> does the optimization work.</p>
<p>From our example above, to fit the model, we simply run:</p>
<div class="codehilite"><pre><span></span><span class="n">model</span><span class="p">.</span><span class="n">optimize_params</span><span class="p">(</span><span class="n">max_iters</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_beta_iters</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_U_iters</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">rel_tol</span><span class="o">=</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
</pre></div>


<p>The parameters that are being optimized are the fixed effects and random effects. The optimization happens iteratively,
and you may not need to completely optimize the fixed and random effects in each overall iteration. To control this process, you 
may pass in any integer for <code>max_iters</code>, <code>max_beta_iters</code>, and <code>max_U_iters</code>. You can also
include a relative tolerance for the total error in the fixed and random effects with the argument <code>rel_tol</code>, and the 
program will terminate if it reaches <code>rel_tol</code> before completing <code>max_iters</code> iterations. We recommend the defaults above for all
of these arguments.</p>
<p>The parameter estimates, including the <script type="math/tex">\beta</script> fixed effects, the <script type="math/tex">U</script> random effects, and the correlation between the outcomes given by <script type="math/tex">D</script> (each described in <a href="../methods/">methods</a>) are all available in the <code>summarize</code> class method for <code>ccount.core.CorrelatedModel</code>. In our example above, to get a printed summary of the estimates (both transformed and un-transformed based on the link functions described in <a href="../models/#choices">the model choices</a>), run the following:</p>
<div class="codehilite"><pre><span></span><span class="n">model</span><span class="p">.</span><span class="n">summarize</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="p">...)</span>
</pre></div>


<p>If you want to save the model summary to a file so that you can access it later, pass <code>file=...</code> and it will re-route the output to whatever file name (must have a <code>.txt</code> extension) that you pass.
If you do not pass a file, i.e. <code>file=None</code>, then it will return the summary in your session.</p>
<h2 id="creating-predictions"><a href="#predictions">Creating Predictions</a></h2>
<p>In order to get the fitted values of deaths and cases, you can use the function <code>ccount.run.get_predictions_from_df</code>. It takes the same arguments as <code>convert_df_to_model</code>, except that in place of <code>model_type</code>, it needs a <code>ccount.core.CorrelatedModel</code> object, and it does not need the outcome variables. For our example above, this looks like</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">ccount.run</span> <span class="kn">import</span> <span class="n">get_predictions_from_df</span>

<span class="n">predictions</span> <span class="o">=</span> <span class="n">get_predictions_from_df</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">df</span><span class="o">=</span><span class="n">some_df</span><span class="p">,</span>
    <span class="n">fixed_effects</span><span class="o">=</span><span class="p">[[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span> <span class="p">[[</span><span class="s1">&#39;median_income&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]]],</span>
    <span class="n">random_effect</span><span class="o">=</span><span class="s1">&#39;country&#39;</span><span class="p">,</span>
    <span class="n">offset</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;population&#39;</span><span class="p">],</span>
    <span class="n">spline</span><span class="o">=</span><span class="p">[[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>
        <span class="p">[[</span><span class="n">spline_specs</span><span class="p">],</span> <span class="p">[</span><span class="n">spline_specs</span><span class="p">]]</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>


<p><code>predictions</code> is a 2-dimensional array that is the length of the data frame <code>some_df</code> along one axis and the outcome predictions along the other (i.e. predictions for deaths and cases).</p>
<p>The <code>fixed_effects</code>, <code>random_effect</code>, <code>offset</code> (if applicable), and <code>weight</code> (if applicable) arguments must be identical to those used in the initial model <a href="./#specification">specification</a>.</p>
<p><em>Note that the data frame passed to <code>get_predictions_from_df</code> need not be the data frame that was used in model fitting.</em> It can be a new data frame with missing outcome variables because they are not used in making predictions since the model has already been fit. However, this new data frame cannot have any missing values for random effects, fixed effects, or offsets. If it includes random effect grouping levels that were not observed in the fitting of the model, the random effect will be 0 for that level.</p>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../models/" title="Models" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Models
              </span>
            </div>
          </a>
        
        
          <a href="../updates/" title="Release Notes" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Release Notes
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.808e90bb.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>